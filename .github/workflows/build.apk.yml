name: ðŸš€ Android CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      upload_to_firebase:
        description: 'Upload to Firebase App Distribution?'
        required: false
        default: false
        type: boolean

env:
  GRADLE_VERSION: '8.5'
  JAVA_VERSION: '17'
  ANDROID_COMPILE_SDK: 34
  ANDROID_BUILD_TOOLS: '34.0.0'
  ANDROID_MIN_SDK: 21
  ANDROID_TARGET_SDK: 34

jobs:
  quality-checks:
    name: ðŸ” Code Quality & Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: âš™ï¸ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'gradle'
        
    - name: ðŸ“¦ Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ðŸ”§ Make gradlew executable
      run: chmod +x ./gradlew
      
    - name: ðŸ§ª Run Unit Tests
      run: ./gradlew testDebugUnitTest
      continue-on-error: true
      
    - name: ðŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          **/build/reports/tests/
          **/build/test-results/
          
    - name: ðŸ§¹ Run Lint Analysis
      run: ./gradlew lintDebug
      continue-on-error: true
      
    - name: ðŸ“ˆ Upload Lint Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lint-report
        path: app/build/reports/lint-results-debug.html

  build-and-analyze:
    name: ðŸ—ï¸ Build & Analyze
    runs-on: ubuntu-latest
    needs: [quality-checks]
    if: success() || github.event_name == 'push'
    
    strategy:
      matrix:
        build_type: [debug, release]
        exclude:
          - build_type: release
            if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Java & Gradle
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: ${{ env.GRADLE_VERSION }}
        cache-disabled: false
        cache-read-only: ${{ github.event_name == 'pull_request' }}
        
    - name: ðŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        build-tools-version: ${{ env.ANDROID_BUILD_TOOLS }}
        ndk-version: '25.2.9519653'
        cmake-version: '3.22.1'
        
    - name: ðŸ” Setup Signing Keys (Release Only)
      if: matrix.build_type == 'release' && github.event_name != 'pull_request'
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > keystore.jks
        echo "RELEASE_STORE_FILE=keystore.jks" >> $GITHUB_ENV
        echo "RELEASE_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
        echo "RELEASE_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> $GITHUB_ENV
        echo "RELEASE_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> $GITHUB_ENV
        
    - name: ðŸ“ Configure Build Environment
      run: |
        echo "BUILD_TYPE=${{ matrix.build_type }}" >> $GITHUB_ENV
        echo "VERSION_CODE=${{ github.run_number }}" >> $GITHUB_ENV
        echo "VERSION_NAME=1.0.${{ github.run_number }}" >> $GITHUB_ENV
        
    - name: ðŸ—ï¸ Build APK
      run: |
        if [ "$BUILD_TYPE" = "release" ]; then
          ./gradlew assembleRelease \
            -PversionCode=$VERSION_CODE \
            -PversionName=$VERSION_NAME \
            --stacktrace
        else
          ./gradlew assembleDebug \
            -PversionCode=$VERSION_CODE \
            -PversionName=$VERSION_NAME \
            --stacktrace
        fi
        
    - name: ðŸ“Š Analyze Build Size
      run: |
        APK_PATH="app/build/outputs/apk/$BUILD_TYPE/app-$BUILD_TYPE.apk"
        if [ -f "$APK_PATH" ]; then
          APK_SIZE=$(stat -f%z "$APK_PATH")
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1048576" | bc)
          echo "APK_SIZE_MB=$APK_SIZE_MB" >> $GITHUB_ENV
          echo "ðŸ“¦ APK Size: $APK_SIZE_MB MB"
        fi
        
    - name: ðŸ—œï¸ Generate App Bundle (Release Only)
      if: matrix.build_type == 'release' && github.event_name != 'pull_request'
      run: |
        ./gradlew bundleRelease \
          -PversionCode=$VERSION_CODE \
          -PversionName=$VERSION_NAME
          
    - name: ðŸš€ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-build-${{ matrix.build_type }}-${{ github.run_number }}
        path: |
          app/build/outputs/apk/${{ matrix.build_type }}/*.apk
          app/build/outputs/bundle/${{ matrix.build_type }}/*.aab
        if-no-files-found: error
        retention-days: 7
        
    - name: ðŸ“‹ Generate Build Report
      run: |
        echo "### ðŸ“Š Build Report ${{ matrix.build_type | upcase }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type**: ${{ matrix.build_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: 1.0.${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **APK Size**: ${{ env.APK_SIZE_MB || 'N/A' }} MB" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: ðŸš€ Deploy & Distribute
    runs-on: ubuntu-latest
    needs: [build-and-analyze]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: android-build-release-*
        path: ./artifacts
        merge-multiple: true
        
    - name: ðŸ” Setup Firebase Service Account
      if: github.event.inputs.upload_to_firebase == 'true'
      run: |
        echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-service-account.json
        
    - name: ðŸ“± Deploy to Firebase App Distribution
      if: github.event.inputs.upload_to_firebase == 'true'
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_APP_ID }}
        serviceCredentialsFile: firebase-service-account.json
        groups: testers
        file: artifacts/app-release.apk
        
    - name: ðŸ·ï¸ Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/*.apk
          artifacts/*.aab
        generate_release_notes: true
        
    - name: ðŸ“¢ Send Build Notification
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#build-notifications'
        username: 'Android CI Bot'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [build-and-analyze]
    if: github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ›¡ï¸ Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'Android-App'
        path: '.'
        format: 'HTML'
        args: >
          --scan .
          --out reports/
          --failOnCVSS 7
          --enableRetired
          
    - name: ðŸ“„ Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: reports/
        
    - name: ðŸ” Check for Secrets in Code
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        extra_args: --no-update

  performance:
    name: âš¡ Performance Metrics
    runs-on: ubuntu-latest
    needs: [build-and-analyze]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Download APK
      uses: actions/download-artifact@v4
      with:
        pattern: android-build-release-*
        path: ./artifacts
        
    - name: ðŸ“ Analyze APK with APKTool
      run: |
        sudo apt-get install -y apktool
        apktool d artifacts/app-release.apk -o apk-analysis
        du -sh apk-analysis/
        
    - name: ðŸ“ˆ Calculate Performance Metrics
      run: |
        echo "### ðŸ“Š Performance Metrics" >> $GITHUB_STEP_SUMMARY
        APK_SIZE=$(stat -f%z "artifacts/app-release.apk")
        APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1048576" | bc)
        echo "- **APK Size**: ${APK_SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY
        echo "- **Target SDK**: ${{ env.ANDROID_TARGET_SDK }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Min SDK**: ${{ env.ANDROID_MIN_SDK }}" >> $GITHUB_STEP_SUMMARY
